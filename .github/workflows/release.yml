name: Build and Release Plugin

on:
  push:
    branches:
      - main
    paths:
      - '_meta.lua'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Extract Version
      - name: Extract Version from _meta.lua
        id: get_version
        run: |
          VERSION=$(grep -oP 'version\s*=\s*["'\'']?\K[0-9.]+' _meta.lua)
          if [ -z "$VERSION" ]; then
            echo "::error::Could not find version in _meta.lua"
            exit 1
          fi
          echo "Found version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # 2. Check for existing tag
      - name: Check if tag exists
        uses: mukunku/tag-exists-action@v1.6.0
        id: check_tag
        with: 
          tag: "v${{ env.VERSION }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3. Extract Release Notes + Add H2 Header to Summary
      - name: Extract Release Notes
        if: steps.check_tag.outputs.exists == 'false'
        id: extract_notes
        run: |
          sed -i 's/\r$//' CHANGELOG.md

          awk -v ver="${{ env.VERSION }}" '
            BEGIN { target = "## [" ver "]" }
            
            # --- Found the Header Line ---
            /^## / && index($0, target) {
                line = $0
                
                # 1. Clean up version part: "## [0.5]"
                sub(/^## \[[^]]+\]/, "", line)
                
                # 2. Clean up date part: " - 2025-12-13"
                sub(/^\s*-\s*[0-9]{4}-[0-9]{2}-[0-9]{2}/, "", line)
                
                # 3. Clean up leading separator: " - "
                sub(/^\s*-\s*/, "", line)
                
                # 4. If text remains, print it with "## " prefix
                if (length(line) > 0) {
                    print "## " line
                    print "" 
                }
                
                flag = 1
                next
            }
            
            # --- Stop at Next Header ---
            /^## \[/ && flag { flag=0 }
            
            # --- Print Body ---
            flag { print }
          ' CHANGELOG.md > release_notes.md
          
          # Clean up empty lines
          sed -i -e :a -e '/^\n*$/{$d;N;};/\n$/ba' release_notes.md

          # Debug
          echo "--- Final Notes ---"
          cat release_notes.md
          echo "-------------------"

          # Fallback
          if [ ! -s release_notes.md ]; then
            echo "New release version ${{ env.VERSION }}" > release_notes.md
          fi

      # 4. Create Archive
      - name: Create Plugin Archive
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          mkdir -p errol.koplugin
          cp main.lua _meta.lua config.example.lua errol.koplugin/
          zip -r errol.koplugin.zip errol.koplugin

      # 5. Create Release
      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          body_path: release_notes.md
          files: errol.koplugin.zip
          draft: false
          prerelease: false